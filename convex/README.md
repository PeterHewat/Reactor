# Convex Backend

This folder contains the Convex backend for the application.

## Initial Setup

### Prerequisites

- A [Convex account](https://dashboard.convex.dev) (free tier available)
- Node.js 24+ installed

### Step 1: Initialize Convex

Run the Convex CLI from the **repository root** (not this folder):

```bash
npx convex dev
```

This interactive command will:

1. Open a browser to log in to Convex (or create an account)
2. Prompt you to create a new project or connect to an existing one
3. Generate the `convex/_generated/` directory with TypeScript types
4. Create `.env.local` in the repository root with your deployment URL

### Step 2: Create Your Schema

After initialization, create `convex/schema.ts` to define your database tables:

```ts
import { defineSchema, defineTable } from "convex/server";
import { v } from "convex/values";

export default defineSchema({
  // Example: users table
  users: defineTable({
    name: v.string(),
    email: v.string(),
    createdAt: v.number(),
  }).index("by_email", ["email"]),

  // Add more tables as needed
});
```

### Step 3: Create Your First Function

Create a query or mutation in `convex/` (e.g., `convex/users.ts`):

```ts
import { query, mutation } from "./_generated/server";
import { v } from "convex/values";

export const list = query({
  args: {},
  handler: async (ctx) => {
    return await ctx.db.query("users").collect();
  },
});

export const create = mutation({
  args: { name: v.string(), email: v.string() },
  handler: async (ctx, args) => {
    return await ctx.db.insert("users", {
      name: args.name,
      email: args.email,
      createdAt: Date.now(),
    });
  },
});
```

### Step 4: Connect the Frontend

In `apps/web/src/main.tsx`, add the Convex provider:

```tsx
import { ConvexProvider, ConvexReactClient } from "convex/react";

const convex = new ConvexReactClient(import.meta.env.VITE_CONVEX_URL);

ReactDOM.createRoot(document.getElementById("root")!).render(
  <ConvexProvider client={convex}>
    <App />
  </ConvexProvider>,
);
```

Add the Convex URL to `apps/web/.env.local`:

```text
VITE_CONVEX_URL=https://your-project.convex.cloud
```

You can find this URL in the Convex dashboard or in the root `.env.local` file.

## Clerk Authentication

To integrate Clerk authentication with Convex:

### 1. Install Clerk in the web app

```bash
npm install -w apps/web @clerk/clerk-react
```

### 2. Configure Clerk Provider

In `apps/web/src/main.tsx`:

```tsx
import { ClerkProvider, useAuth } from "@clerk/clerk-react";
import { ConvexProviderWithClerk } from "convex/react-clerk";
import { ConvexReactClient } from "convex/react";

const convex = new ConvexReactClient(import.meta.env.VITE_CONVEX_URL);

ReactDOM.createRoot(document.getElementById("root")!).render(
  <ClerkProvider publishableKey={import.meta.env.VITE_CLERK_PUBLISHABLE_KEY}>
    <ConvexProviderWithClerk client={convex} useAuth={useAuth}>
      <App />
    </ConvexProviderWithClerk>
  </ClerkProvider>,
);
```

### 3. Configure Convex for Clerk

Create `convex/auth.config.ts`:

```ts
export default {
  providers: [
    {
      domain: process.env.CLERK_JWT_ISSUER_DOMAIN,
      applicationID: "convex",
    },
  ],
};
```

### 4. Use Authentication in Functions

Use the `auth` helper in your Convex functions:

```ts
import { query, mutation } from "./_generated/server";
import { v } from "convex/values";

export const getMyData = query({
  args: {},
  handler: async (ctx) => {
    const identity = await ctx.auth.getUserIdentity();
    if (!identity) {
      throw new Error("Not authenticated");
    }
    // Use identity.subject as the user ID
    return ctx.db
      .query("data")
      .filter((q) => q.eq(q.field("userId"), identity.subject))
      .collect();
  },
});
```

## Environment Variables

After setup, you'll need these environment variables:

### `.env.local` (auto-generated by Convex CLI)

```text
CONVEX_DEPLOYMENT=dev:your-project-name
```

### `apps/web/.env.local`

```text
VITE_CONVEX_URL=https://your-project.convex.cloud
VITE_CLERK_PUBLISHABLE_KEY=pk_test_...
```

### Convex Dashboard Environment Variables

Set these in the Convex dashboard under Settings > Environment Variables:

```text
CLERK_JWT_ISSUER_DOMAIN=https://your-clerk-domain.clerk.accounts.dev
```

## File Structure

After scaffolding, your convex folder will look like:

```text
convex/
  _generated/       # Auto-generated types (don't edit)
  schema.ts         # Database schema
  auth.config.ts    # Auth configuration
  *.ts              # Your queries, mutations, actions
```

## Resources

- [Convex Documentation](https://docs.convex.dev/)
- [Convex + Clerk Integration](https://docs.convex.dev/auth/clerk)
- [Convex TypeScript Guide](https://docs.convex.dev/typescript)
